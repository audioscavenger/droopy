<!DOCTYPE html>
<html>
  <head>
    <!--# version: 1.3.2 -->
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <!-- fallback -->
    <!-- <script src="redist/jquery.min.js"></script> -->

    <!-- dropzone 6 drops support for IE; also cdnjs.cloudflare is 50% faster then unpkg -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" /> -->
    <!-- <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script> -->
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css" rel="stylesheet" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js" type="text/javascript"></script>
    <!-- fallback -->
    <!-- <link  href="redist/dropzone.min.css" rel="stylesheet" type="text/css"> -->
    <!-- <script src="redist/dropzone.min.js" type="text/javascript"></script> -->

    <link href="style.css" rel="stylesheet" type="text/css">

  </head>
  <body >
    <div>
      <div>Command line: curl <span id="url"></span>upload-basic.php -F userfile=@<i>file.ext</i></div>
      <form enctype="multipart/form-data" action="upload-basic.php" method="POST">
        <!-- MAX_FILE_SIZE must precede the file input field // not sure it's even used -->
        <input type="hidden" name="MAX_FILE_SIZE" value="2147483648" />
        <!-- Name of input element determines name in $_FILES array -->
        Fallback no chunck: <input name="userfile" type="file" />
        <input type="submit" value="Send File" />
      </form>
    <script type="text/javascript">document.getElementById("url").innerHTML = window.location.href;</script>
    </div>

    <div class="container" >
      <div class='content'>
        <script>
        // https://github.com/dropzone/dropzone/blob/main/src/options.js
        // https://stackoverflow.com/questions/56156402/how-to-concatenate-chunked-file-uploads-from-dropzone-js-with-php
        // https://stackoverflow.com/questions/49769853/dropzone-js-chunking
        // $(function () {    // this gives an error: Uncaught Error: Dropzone already attached.
          //myDropzone = new Dropzone('#dropzone', {
          Dropzone.options.dropzone = {
            accept: function(file, done) {
              // console.debug('file',file);
              if (file.name == "forbidden-filename.vbs") {
                done("Naha, you don't.");
              // } else if (file.type == "image/png") {
                // done("Naha, you don't.");
              } else { done(); }
            },
            /*
            // apparently not needed anymore
            init: function() {
              this.on("uploadprogress", function(file, progress) {
                console.log("File progress", progress);
              });
            },
            */
            maxFilesize: 2048,           // Mbytes
            chunking: true,
            chunkSize: 1000000,         // bytes
            parallelChunkUploads: true,
            retryChunks: true,
            forceChunking: true,
            
            chunksUploaded: function(file, done) {
              // All chunks have been uploaded. Perform any other actions
              // file.name: "1x1 - Copy.png"
              // file.type: "image/png"
              
              // TODO: html protect fileName?
              let fileName = file.name.split('.').slice(0, -1).join('.') || file.name;
              let fileExt = file.name.slice((file.name.lastIndexOf(".") - 1 >>> 0) + 2);
              let subFolder = (fileExt.toUpperCase() == 'NEF') ? 'DCIM/' : '';
              
              // The below is done on the PHP side so we shall not do it here
              // Remove anything which isn't a word, whitespace, number, or any of the following caracters: "-_~[]()."
              //var htmlName = file.name.replace(/([^\w\s\d\-_~\,\;\[\]\(\)\.]+)/, '')
              // also Remove any runs of periods
              //htmlName = htmlName.replace(/([\.]{2,})/, '.');
              
              
              /*
              // Remove anything which isn't a word, whitespace, number, or any of the following caracters: "-_~[]()."
              $fileName = mb_ereg_replace("([^\w\s\d\-_~\,\;\[\]\(\)\.])", '', $_GET['fileName']);
              // also Remove any runs of periods
              $fileName = mb_ereg_replace("([\.]{2,})", '', $fileName);
              // Remove anything which isn't a word, whitespace, number, or any of the following caracters: "-_~[]()"
              $fileExt = mb_ereg_replace("([^\w\s\d\-_~\,\;\[\]\(\)])", '', $_GET['fileExt']);
              */


              // This calls server-side code to merge all chunks for the file
              // This is where you can alter the result icon to show a download link for instance
              // https://stackoverflow.com/questions/21050275/download-uploaded-file-with-dropzonejs
              
              // console.debug("url","chunk-concat.php?dzuuid=" + file.upload.uuid + "&dztotalchunkcount=" + file.upload.totalChunkCount + "&fileName=" + fileName + "&fileExt=" + fileExt);
              
              $.ajax({
                url: "chunk-concat.php?dzuuid=" + file.upload.uuid + "&dztotalchunkcount=" + file.upload.totalChunkCount + "&fileName=" + encodeURI(fileName) + "&fileExt=" + encodeURI(fileExt),
                success: function (data) {
                  // console.debug('data',data);                     // {"status":"DONE","info":"","file_link":"uploads\/filename.ext"}
                  // console.debug('file',file);                     // object
                  // console.debug('file.name',file.name);           // "favicon - /\\'[x] Copy...png"
                  // console.debug('fileName',fileName+"."+fileExt); // sent as POST
                  
                  var htmlName = encodeURI(JSON.parse(data).file_link); // htmlName is html encoded already by JSON.parse
                  // console.debug('htmlName',htmlName);     // expected remote name html encoded
                  
                  let div = document.createElement('div');
                  div.setAttribute('style', 'font-size:smaller; text-align: center;');
                  let a = document.createElement('a');
                  a.setAttribute('style', 'cursor: pointer;');
                  a.setAttribute('href',"/droopy/" + subFolder + htmlName + "?nocache=" + Date.now());
                  a.innerHTML = "download";
                  
                  div.appendChild(a);
                  file.previewTemplate.appendChild(div);
                  
                  done();
                },
                error: function (msg) {
                    console.error(msg);
                    file.accepted = false;
                    //myDropzone._errorProcessing([file], msg.responseText); // var myDropzone = new Dropzone
                }
              });
            }
          }   // Dropzone.options.dropzone
          // });   // var myDropzone = new Dropzone
        // });     // $(function ()
        </script>
        
        <!-- <form id="dropzone" action="test/upload.php" class="dropzone" method="post" enctype="multipart/form-data"> -->
        <form id="dropzone" action="chunk-upload.php" class="dropzone" method="post" enctype="multipart/form-data">
          <div class="fallback">
            <input name="file" type="file" multiple />
          </div>
        </form>
        
      </div>
    </div>


  </body>
</html>